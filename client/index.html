<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="description" content="EOX :: WMM ISO-lines Demo">

  <!-- Allow address bar to hide on mobiles -->
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />

  <title>EOX :: WMM ISO-lines Demo</title>
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />

  <!-- Styles -->
  <link href="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/css/bootstrap.min.css" rel="stylesheet" type="text/css" media="screen">
  <link href="http://netdna.bootstrapcdn.com/font-awesome/4.0.2/css/font-awesome.min.css" rel="stylesheet">
  <link href="./styles/styles.css" rel="stylesheet" type="text/css" media="all" />
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Sans:400,700">
  <link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Droid+Serif">

</head>
<body data-spy="scroll" data-target=".navbar" data-offset="75">
<nav class="navbar navbar-inverse navbar-fixed-top">
    <div class="navbar-header">
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" style="font-size: 160%"><i class="fa fa-globe"></i> EOX::WMM ISO-lines Demo</a>
    </div>
</nav>

<!-- Main Map Element -->
<div class="jumbotron frontpage" style="position: relative;">
  <div id="map">
      <div id="zoom" class="btn-toolbar-vertical btn-group-sm">
          <div class="btn-group-vertical btn-group-sm">
              <button type="button" onclick="map.getView().setZoom(map.getView().getZoom() + 1);" class="btn btn-default"><i class="fa fa-fw fa-plus"></i></button>
              <button type="button" onclick="map.getView().setZoom(map.getView().getZoom() - 1);" class="btn btn-default"><i class="fa fa-fw fa-minus"></i></button>
          </div>
          <button type="button" id="expand" class="btn btn-default"><i class="fa fa-fw fa-expand"></i></button>
      </div>
      <div id="tools" class="btn-group btn-group-sm">
          <div class="btn-group btn-group-sm">
              <button type="button" id="layerSwitcher" class="btn btn-default dropdown-toggle" data-toggle="dropdown"><i class="fa fa-globe"></i> Declination <i class="fa fa-caret-down"></i></button>
              <ul class="dropdown-menu">
                  <li><a href="#" class="baseLayer" data-layer="Declination"><i class="fa fa-check-square-o" data-layer="Declination"></i> Declination</a></li>
                  <li><a href="#" class="baseLayer" data-layer="Inclination"><i class="fa fa-square-o" data-layer="Inclination"></i> Inclination</a></li>
                  <li><a href="#" class="baseLayer" data-layer="F"><i class="fa fa-square-o" data-layer="F"></i> F</a></li>
                  <li><a href="#" class="baseLayer" data-layer="H"><i class="fa fa-square-o" data-layer="H"></i> H</a></li>
                  <li><a href="#" class="baseLayer" data-layer="X"><i class="fa fa-square-o" data-layer="X"></i> X</a></li>
                  <li><a href="#" class="baseLayer" data-layer="Y"><i class="fa fa-square-o" data-layer="Y"></i> Y</a></li>
                  <li><a href="#" class="baseLayer" data-layer="Z"><i class="fa fa-square-o" data-layer="Z"></i> Z</a></li>
              </ul>
          </div>
          <div class="btn-group btn-group-sm" data-toggle="buttons">
              <label class="btn btn-default"><input type="checkbox" id="overlay"><i class="fa fa-road"></i> Overlay</label>
          </div>
      </div>
      <div class="panel panel-default div-slider-bottom">
        <input id="timeslider" type="range" min="0" max="60" step="1"i value="48"/>
      </div>
      <div class="panel panel-default div-time-show">
        <div id="time-show" class="panel-heading">2014-1-1</div>
      </div>
      <div class="panel panel-default div-slider-right">
        <div id="elevation-show" class="panel-heading">Elevation: 0</div>
        <div class="panel-body">
          <input id="elevationslider" type="range" min="-1" max="850" value="0"/>
        </div>
      </div>
    </div>
</div>
<!-- Bootstrap -->
<script src="http://code.jquery.com/jquery.js" type="text/javascript"></script>
<script src="http://netdna.bootstrapcdn.com/bootstrap/3.0.2/js/bootstrap.min.js" type="text/javascript"></script>
<script src='http://ol3js.org/en/master/build/ol.js'></script>
<script>

function getWMTSTileGridForProjection(projection, maxZoom, square) {
  var projectionExtent = projection.getExtent();
  var size = ol.extent.getWidth(projectionExtent) / 256;

  var resolutions = new Array(maxZoom);
  var matrixIds = new Array(maxZoom);

  var offset = square ? 0 : 1;
  for (var z = 0; z < maxZoom; ++z) {
    // generate resolutions and matrixIds arrays for this WMTS
    resolutions[z] = size / Math.pow(2, z + offset);
    matrixIds[z] = z;
  }

  return new ol.tilegrid.WMTS({
    origin: ol.extent.getTopLeft(projectionExtent),
    resolutions: resolutions,
    matrixIds: matrixIds
  });
}


var urls = [
    'http://a.tiles.maps.eox.at/wmts/',
    'http://b.tiles.maps.eox.at/wmts/',
    'http://c.tiles.maps.eox.at/wmts/',
    'http://d.tiles.maps.eox.at/wmts/',
    'http://e.tiles.maps.eox.at/wmts/',
    'http://f.tiles.maps.eox.at/wmts/',
  ];

layer = new ol.layer.Tile({
  source: new ol.source.TileWMS({
    url: '/cache',
    params: {
      'VERSION': '1.3.0',
      'LAYERS': 'Declination',
      'FORMAT': 'image/png',
      'ELEVATION': "0",
      'TIME': "2014-1-1"
    },
    extent: [-180, -90, 180, 90],
  })
});


overlay = new ol.layer.Tile({
  source: new ol.source.WMTS({
    url: urls,
    layer: "overlay",
    matrixSet: "WGS84",
    format: 'image/jpeg',
    projection: ol.proj.get('EPSG:4326'),
    tileGrid: getWMTSTileGridForProjection(ol.proj.get('EPSG:4326'), 15, false),
    extent: [-180, -90, 180, 90],
    style: 'default'
  }),
  visible: false
});


var layers = [
  new ol.layer.Tile({
    source: new ol.source.WMTS({
      url: urls,
      layer: "terrain",
      matrixSet: "WGS84",
      format: 'image/jpeg',
      projection: ol.proj.get('EPSG:4326'),
      tileGrid: getWMTSTileGridForProjection(ol.proj.get('EPSG:4326'), 15, false),
      extent: [-180, -90, 180, 90],
      style: 'default'
    })
  }),
  layer,
  overlay
];

map = new ol.Map({
  controls: ol.control.defaults(),
  layers: layers,
  target: 'map',
  view: new ol.View2D({
    projection: 'EPSG:4326',
    center: [0, 0],
    zoom: 2
  })
});

$('.baseLayer').on('click.baselayer', function(e) {
  layer.getSource().updateParams({'LAYERS': $(e.target).data('layer')});
  $('#layerSwitcher').html("<i class='fa fa-globe'></i> " + $(e.target).data('layer') + "  <i class='fa fa-caret-down'></i>" );
});

$('#overlay').on('change.overlay', function(e) {
  overlay.set("visible", this.checked);
});

function getTime(raw) {
  var value = parseInt(raw);
  var y = 2010 + Math.floor(value / 12);
  var m = (value % 12) + 1;
  return "" + y + "-" + m + "-1"
}

$("#timeslider").on("input", function(event) {
  $("#time-show").text(getTime($("#timeslider").val()));
});

$("#timeslider").on("change", function(event) {
  layer.getSource().updateParams({'TIME': getTime($("#timeslider").val())});
});

$("#elevationslider").on("input", function(event) {
  $("#elevation-show").text("Elevation: " + $("#elevationslider").val());
});

$("#elevationslider").on("change", function(event) {
  layer.getSource().updateParams({'ELEVATION': $("#elevationslider").val()});
});



</script>



</html>
